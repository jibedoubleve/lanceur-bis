<script>
(function() {
  /* Get stored preference or detect OS preference */
  function getPreferredTheme() {
    const stored = localStorage.getItem('theme');
    if (stored) {
      return stored;
    }
    return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
  }

  /* Apply theme immediately to prevent flash */
  function applyTheme(theme) {
    if (typeof jtd !== 'undefined' && jtd.setTheme) {
      jtd.setTheme(theme);
    } else {
      /* Fallback: set data attribute directly */
      document.documentElement.setAttribute('data-theme', theme);
    }
    localStorage.setItem('theme', theme);

    /* Update toggle button icon if it exists */
    const toggleBtn = document.getElementById('theme-toggle');
    if (toggleBtn) {
      toggleBtn.innerHTML = theme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
      toggleBtn.setAttribute('aria-label', theme === 'dark' ? 'Switch to light mode' : 'Switch to dark mode');
    }
  }

  /* Apply theme on page load */
  const initialTheme = getPreferredTheme();
  applyTheme(initialTheme);

  /* Listen for OS theme changes */
  window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', function(e) {
    /* Only auto-switch if user hasn't manually set a preference */
    if (!localStorage.getItem('theme')) {
      applyTheme(e.matches ? 'dark' : 'light');
    }
  });

  /* Expose toggle function globally */
  window.toggleTheme = function() {
    const currentTheme = localStorage.getItem('theme') || getPreferredTheme();
    const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
    applyTheme(newTheme);
  };

  /* Re-apply theme when DOM is ready (for jtd.setTheme to work) */
  document.addEventListener('DOMContentLoaded', function() {
    applyTheme(getPreferredTheme());
  });
})();
</script>
